name: "build"
on:
  pull_request:
  push:

jobs:
  homemanager:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        home:
          - "tshm@PN0093"
          - "tshm@minf"
          - "tshm@PD0056"
          - "tshm@x360"
    steps:
      - name: Checkout flake
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v16

      - uses: cachix/cachix-action@v14
        with:
          name: tshmcache
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Build ${{ matrix.home }}
        run: |
          nix run home-manager/master
          -- build --flake .#${{ matrix.home }}

  nixos:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        host: ["x360", "minf"]
    steps:
      - name: Checkout flake
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v16

      - uses: cachix/cachix-action@v14
        with:
          name: tshmcache
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Build ${{ matrix.host }}
        run: |
          nix --extra-experimental-features
          "nix-command flakes" build
          '.#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel'
